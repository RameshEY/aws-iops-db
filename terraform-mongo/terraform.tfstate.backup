{
    "version": 3,
    "terraform_version": "0.11.1",
    "serial": 3,
    "lineage": "56921c07-ba93-49ad-95a2-4f31afc1d58a",
    "modules": [
        {
            "path": [
                "root"
            ],
            "outputs": {},
            "resources": {
                "aws_security_group.km_blog": {
                    "type": "aws_security_group",
                    "depends_on": [],
                    "primary": {
                        "id": "sg-cb5574be",
                        "attributes": {
                            "description": "Allow all inbound traffic",
                            "egress.#": "1",
                            "egress.482069346.cidr_blocks.#": "1",
                            "egress.482069346.cidr_blocks.0": "0.0.0.0/0",
                            "egress.482069346.description": "",
                            "egress.482069346.from_port": "0",
                            "egress.482069346.ipv6_cidr_blocks.#": "0",
                            "egress.482069346.prefix_list_ids.#": "0",
                            "egress.482069346.protocol": "-1",
                            "egress.482069346.security_groups.#": "0",
                            "egress.482069346.self": "false",
                            "egress.482069346.to_port": "0",
                            "id": "sg-cb5574be",
                            "ingress.#": "1",
                            "ingress.482069346.cidr_blocks.#": "1",
                            "ingress.482069346.cidr_blocks.0": "0.0.0.0/0",
                            "ingress.482069346.description": "",
                            "ingress.482069346.from_port": "0",
                            "ingress.482069346.ipv6_cidr_blocks.#": "0",
                            "ingress.482069346.protocol": "-1",
                            "ingress.482069346.security_groups.#": "0",
                            "ingress.482069346.self": "false",
                            "ingress.482069346.to_port": "0",
                            "name": "km_blog",
                            "owner_id": "884956725745",
                            "revoke_rules_on_delete": "false",
                            "tags.%": "0",
                            "vpc_id": "vpc-ae6425ca"
                        },
                        "meta": {
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.aws"
                },
                "data.template_file.user_data": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "a82bcf6f84b7fcfc76fd7142240801c74cc0370ebc05f58db23c6033bca064ee",
                        "attributes": {
                            "id": "a82bcf6f84b7fcfc76fd7142240801c74cc0370ebc05f58db23c6033bca064ee",
                            "rendered": "#!/bin/bash -v\n\n\n\n#\n# apt\n#\nDEBIAN_FRONTEND=noninteractive apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6\necho \"deb [ arch=amd64 ] http://repo.mongodb.com/apt/ubuntu trusty/mongodb-enterprise/3.6 multiverse\" | sudo tee /etc/apt/sources.list.d/mongodb-enterprise.list\nDEBIAN_FRONTEND=noninteractive apt-key update -y\nDEBIAN_FRONTEND=noninteractive apt-get update -y\nDEBIAN_FRONTEND=noninteractive apt-get install -y awscli\nDEBIAN_FRONTEND=noninteractive apt-get install -y ntp\n\n#\n# RAID-0 local ephemeral SSDs on /data\n#\nif [ \"true\" == \"true\" ]; then\n  DEBIAN_FRONTEND=noninteractive apt-get install -y mdadm\n  umount /mnt\n\n  mkdir -p /opt\n  yes | mdadm --create --verbose /dev/md0 --level=0 --name=opt --raid-devices=2 /dev/xvdb /dev/xvdc\n  mkfs.ext4 -L opt /dev/md0\n  mount LABEL=opt /opt\nfi\n\n#\n# EBS SSDs for persistence on /opt\n#\nif [ \"true\" == \"true\" ]; then\n\n  # wait until the volume is attached\n  while [ ! -e /dev/xvdz ]; do\n    echo \"Waiting for EBS /dev/xvdz volume to attach to instance .. \"\n    sleep 1;\n  done\n  mkdir -p /opt\n\n  #\n  # IMPORTANT: only format the volume if uninitialized (i.e. first boot for a fresh volume)\n  #\n  parted /dev/xvdz print || mkfs.ext4 -L opt /dev/xvdz\n  mount LABEL=opt /opt\nfi\n\n#\n# MongoDB Tuning\n#\necho LC_ALL=\\\"en_US.UTF-8\\\" \u003e\u003e /etc/default/locale\n\n# kernel tuning recommended by MongoDB\necho never \u003e /sys/kernel/mm/transparent_hugepage/enabled\necho never \u003e /sys/kernel/mm/transparent_hugepage/defrag\n\n# virtual memory tuning\n#dirty ratio  and dirtybackground ratio change\n# Swapiness vm.swapiness=TBD\n#\n\n# shorter keepalives, 120s recommended for MongoDB in official docs:\n# https://docs.mongodb.org/manual/faq/diagnostics/#does-tcp-keepalive-time-affect-mongodb-deployments\nsysctl -w net.ipv4.tcp_keepalive_time=120\ncat \u003c\u003c EOF \u003e /etc/sysctl.conf\nnet.ipv4.tcp_keepalive_time = 120\nfs.file-max = 65536\nvm.dirty_ratio=15\nvm.dirty_background_ratio=5\nEOF\nsysctl -p\n\n# MongoDB prefers file limits \u003e 20,000\ncat \u003c\u003c EOF \u003e /etc/security/limits.conf\n* soft     nproc          65535\n* hard     nproc          65535\n* soft     nofile         65535\n* hard     nofile         65535\nEOF\n\n# NUMA for MongoDB optimizations when supported\nDEBIAN_FRONTEND=noninteractive apt-get install -y numactl\n\n# required to avoid:\n# \"mongod: error while loading shared libraries: libnetsnmpmibs.so.30: cannot open shared object file: No such file or directory\"\nDEBIAN_FRONTEND=noninteractive apt-get install -y libsnmp-dev\n\n  # Install MongoDB\n  DEBIAN_FRONTEND=noninteractive apt-get install -y mongodb-enterprise=3.6 mongodb-enterprise-server=3.6 mongodb-enterprise-shell=3.6 mongodb-enterprise-mongos=3.6 mongodb-enterprise-tools=3.6\n\n  # prevent unintended upgrades by pinning the package\n  echo \"mongodb-enterprise hold\" | dpkg --set-selections\n  echo \"mongodb-enterprise-server hold\" | dpkg --set-selections\n  echo \"mongodb-enterprise-shell hold\" | dpkg --set-selections\n  echo \"mongodb-enterprise-mongos hold\" | dpkg --set-selections\n  echo \"mongodb-enterprise-tools hold\" | dpkg --set-selections\n\n  # NOTE: it sets mongodb user for everything inside! (\"/opt/mongo\")\n  mkdir -p /data/db\n  chown mongodb:mongodb -R /data/db\n\n  # explicit default owner for parent directory (\"/opt\")\n  chown root:root \"$(dirname \"/data/db\")\"\n\n  # NOTE: it sets the permission for everything inside! (in \"/opt\")\n  chmod 755 -R \"$(dirname \"/data/db\")\"\n\n  # ensure ./mongo/data directory exists\n  mkdir -p /data/db/data\n  chown mongodb:mongodb /data/db/data\n\n  # setup mongodb.key\n  ENC_KEY_PATH=/data/db/mongodb.key\n\n  chmod 600 $ENC_KEY_PATH\n  chown mongodb:mongodb $ENC_KEY_PATH\n\n  cat \u003c\u003c EOF \u003e /etc/mongod.conf\nstorage:\n  dbPath: /data/db/data\n  journal:\n    enabled: true\n  engine: /etc/mongod.conf\n\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /var/log/mongodb/mongod.log\n\nnet:\n  bindIp: 0.0.0.0\n  port: 27017\n\nsecurity:\n   keyFile: \"$ENC_KEY_PATH\"\n\nEOF\n\n  service mongod stop\n  service mongod start\n\n\n\n\n\n\n\n\n\n  mkdir -p /data/db/backup-data\n  chown mongodb:mongodb /data/db/backup-data\n\n  cp /etc/init/mongod.conf /etc/init/mongod-backup.conf\n  sed -i \"s/\\/var\\/lib\\/mongodb/\\/var\\/lib\\/mongodb-backup/g\" /etc/init/mongod-backup.conf\n  sed -i \"s/\\/var\\/log\\/mongodb/\\/var\\/log\\/mongodb-backup/g\" /etc/init/mongod-backup.conf\n  sed -i \"s/\\/var\\/run\\/mongodb/\\/var\\/run\\/mongodb-backup/g\" /etc/init/mongod-backup.conf\n  sed -i \"s/\\/etc\\/mongod.conf/\\/etc\\/mongod-backup.conf/g\" /etc/init/mongod-backup.conf\n  sed -i \"s/\\/etc\\/default\\/mongod/\\/etc\\/default\\/mongod-backup/g\" /etc/init/mongod-backup.conf\n  service mongod-backup start\n\n  wget http://download.oracle.com/otn-pub/java/jdk/7u40-b43/jdk-7u40-linux-x64.rpm?AuthParam=11232426132 -o jdk-7u40-linux-x64.rpm\n  rpm -Uvh jdk-7u40-linux-x64.rpm\n\n  sudo yum install java-devel\n\n  wget http://ftp.heanet.ie/mirrors/www.apache.org/dist/maven/maven-3/3.1.1/binaries/apache-maven-3.1.1-bin.tar.gz\n  sudo tar xzf apache-maven-*-bin.tar.gz -C /usr/local\n  cd /usr/local\n  sudo ln -s apache-maven-* maven\n  sudo vi /etc/profile.d/maven.sh\n\n  export M2_HOME=/usr/local/maven\n\n\n  bash\n  mvn -version\n\n  curl -O --location https://github.com/brianfrankcooper/YCSB/releases/download/0.5.0/ycsb-0.5.0.tar.gz\n  tar xfvz ycsb-0.5.0.tar.gz\n  cd ycsb-0.5.0\n\n\nfi\n",
                            "template": "#!/bin/bash -v\n\n\n\n#\n# apt\n#\nDEBIAN_FRONTEND=noninteractive apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6\necho \"deb [ arch=amd64 ] http://repo.mongodb.com/apt/ubuntu trusty/mongodb-enterprise/3.6 multiverse\" | sudo tee /etc/apt/sources.list.d/mongodb-enterprise.list\nDEBIAN_FRONTEND=noninteractive apt-key update -y\nDEBIAN_FRONTEND=noninteractive apt-get update -y\nDEBIAN_FRONTEND=noninteractive apt-get install -y awscli\nDEBIAN_FRONTEND=noninteractive apt-get install -y ntp\n\n#\n# RAID-0 local ephemeral SSDs on /data\n#\nif [ \"${config_ephemeral}\" == \"true\" ]; then\n  DEBIAN_FRONTEND=noninteractive apt-get install -y mdadm\n  umount /mnt\n\n  mkdir -p /opt\n  yes | mdadm --create --verbose /dev/md0 --level=0 --name=opt --raid-devices=2 /dev/xvdb /dev/xvdc\n  mkfs.ext4 -L opt /dev/md0\n  mount LABEL=opt /opt\nfi\n\n#\n# EBS SSDs for persistence on /opt\n#\nif [ \"${config_ebs}\" == \"true\" ]; then\n\n  # wait until the volume is attached\n  while [ ! -e /dev/xvdz ]; do\n    echo \"Waiting for EBS /dev/xvdz volume to attach to instance .. \"\n    sleep 1;\n  done\n  mkdir -p /opt\n\n  #\n  # IMPORTANT: only format the volume if uninitialized (i.e. first boot for a fresh volume)\n  #\n  parted /dev/xvdz print || mkfs.ext4 -L opt /dev/xvdz\n  mount LABEL=opt /opt\nfi\n\n#\n# MongoDB Tuning\n#\necho LC_ALL=\\\"en_US.UTF-8\\\" \u003e\u003e /etc/default/locale\n\n# kernel tuning recommended by MongoDB\necho never \u003e /sys/kernel/mm/transparent_hugepage/enabled\necho never \u003e /sys/kernel/mm/transparent_hugepage/defrag\n\n# virtual memory tuning\n#dirty ratio  and dirtybackground ratio change\n# Swapiness vm.swapiness=TBD\n#\n\n# shorter keepalives, 120s recommended for MongoDB in official docs:\n# https://docs.mongodb.org/manual/faq/diagnostics/#does-tcp-keepalive-time-affect-mongodb-deployments\nsysctl -w net.ipv4.tcp_keepalive_time=120\ncat \u003c\u003c EOF \u003e /etc/sysctl.conf\nnet.ipv4.tcp_keepalive_time = 120\nfs.file-max = 65536\nvm.dirty_ratio=15\nvm.dirty_background_ratio=5\nEOF\nsysctl -p\n\n# MongoDB prefers file limits \u003e 20,000\ncat \u003c\u003c EOF \u003e /etc/security/limits.conf\n* soft     nproc          65535\n* hard     nproc          65535\n* soft     nofile         65535\n* hard     nofile         65535\nEOF\n\n# NUMA for MongoDB optimizations when supported\nDEBIAN_FRONTEND=noninteractive apt-get install -y numactl\n\n# required to avoid:\n# \"mongod: error while loading shared libraries: libnetsnmpmibs.so.30: cannot open shared object file: No such file or directory\"\nDEBIAN_FRONTEND=noninteractive apt-get install -y libsnmp-dev\n\n  # Install MongoDB\n  DEBIAN_FRONTEND=noninteractive apt-get install -y mongodb-enterprise=${mongodb_version} mongodb-enterprise-server=${mongodb_version} mongodb-enterprise-shell=${mongodb_version} mongodb-enterprise-mongos=${mongodb_version} mongodb-enterprise-tools=${mongodb_version}\n\n  # prevent unintended upgrades by pinning the package\n  echo \"mongodb-enterprise hold\" | dpkg --set-selections\n  echo \"mongodb-enterprise-server hold\" | dpkg --set-selections\n  echo \"mongodb-enterprise-shell hold\" | dpkg --set-selections\n  echo \"mongodb-enterprise-mongos hold\" | dpkg --set-selections\n  echo \"mongodb-enterprise-tools hold\" | dpkg --set-selections\n\n  # NOTE: it sets mongodb user for everything inside! (\"/opt/mongo\")\n  mkdir -p ${mongodb_basedir}\n  chown mongodb:mongodb -R ${mongodb_basedir}\n\n  # explicit default owner for parent directory (\"/opt\")\n  chown root:root \"$(dirname \"${mongodb_basedir}\")\"\n\n  # NOTE: it sets the permission for everything inside! (in \"/opt\")\n  chmod 755 -R \"$(dirname \"${mongodb_basedir}\")\"\n\n  # ensure ./mongo/data directory exists\n  mkdir -p ${mongodb_basedir}/data\n  chown mongodb:mongodb ${mongodb_basedir}/data\n\n  # setup mongodb.key\n  ENC_KEY_PATH=${mongodb_basedir}/mongodb.key\n\n  chmod 600 $ENC_KEY_PATH\n  chown mongodb:mongodb $ENC_KEY_PATH\n\n  cat \u003c\u003c EOF \u003e /etc/mongod.conf\nstorage:\n  dbPath: ${mongodb_basedir}/data\n  journal:\n    enabled: true\n  engine: ${mongodb_conf_engine}\n\nsystemLog:\n  destination: file\n  logAppend: true\n  path: ${mongodb_conf_logpath}\n\nnet:\n  bindIp: 0.0.0.0\n  port: 27017\n\nsecurity:\n   keyFile: \"$ENC_KEY_PATH\"\n\nEOF\n\n  service mongod stop\n  service mongod start\n\n\n\n\n\n\n\n\n\n  mkdir -p ${mongodb_basedir}/backup-data\n  chown mongodb:mongodb ${mongodb_basedir}/backup-data\n\n  cp /etc/init/mongod.conf /etc/init/mongod-backup.conf\n  sed -i \"s/\\/var\\/lib\\/mongodb/\\/var\\/lib\\/mongodb-backup/g\" /etc/init/mongod-backup.conf\n  sed -i \"s/\\/var\\/log\\/mongodb/\\/var\\/log\\/mongodb-backup/g\" /etc/init/mongod-backup.conf\n  sed -i \"s/\\/var\\/run\\/mongodb/\\/var\\/run\\/mongodb-backup/g\" /etc/init/mongod-backup.conf\n  sed -i \"s/\\/etc\\/mongod.conf/\\/etc\\/mongod-backup.conf/g\" /etc/init/mongod-backup.conf\n  sed -i \"s/\\/etc\\/default\\/mongod/\\/etc\\/default\\/mongod-backup/g\" /etc/init/mongod-backup.conf\n  service mongod-backup start\n\n  wget http://download.oracle.com/otn-pub/java/jdk/7u40-b43/jdk-7u40-linux-x64.rpm?AuthParam=11232426132 -o jdk-7u40-linux-x64.rpm\n  rpm -Uvh jdk-7u40-linux-x64.rpm\n\n  sudo yum install java-devel\n\n  wget http://ftp.heanet.ie/mirrors/www.apache.org/dist/maven/maven-3/3.1.1/binaries/apache-maven-3.1.1-bin.tar.gz\n  sudo tar xzf apache-maven-*-bin.tar.gz -C /usr/local\n  cd /usr/local\n  sudo ln -s apache-maven-* maven\n  sudo vi /etc/profile.d/maven.sh\n\n  export M2_HOME=/usr/local/maven\n\n\n  bash\n  mvn -version\n\n  curl -O --location https://github.com/brianfrankcooper/YCSB/releases/download/0.5.0/ycsb-0.5.0.tar.gz\n  tar xfvz ycsb-0.5.0.tar.gz\n  cd ycsb-0.5.0\n\n\nfi\n",
                            "vars.%": "7",
                            "vars.aws_region": "us-east-1",
                            "vars.config_ebs": "true",
                            "vars.config_ephemeral": "true",
                            "vars.mongodb_basedir": "/data/db",
                            "vars.mongodb_conf_engine": "/etc/mongod.conf",
                            "vars.mongodb_conf_logpath": "/var/log/mongodb/mongod.log",
                            "vars.mongodb_version": "3.6"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": "provider.template"
                }
            },
            "depends_on": []
        }
    ]
}
